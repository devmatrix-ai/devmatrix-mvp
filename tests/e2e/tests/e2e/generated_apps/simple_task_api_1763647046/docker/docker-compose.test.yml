version: '3.8'

# Test Environment Docker Compose for {{ app_name }}
# Generated by DevMatrix - Isolated Testing Infrastructure
# Services: Test Database + Test Runner

services:
  # ============================================================================
  # Test Database - Isolated PostgreSQL for Testing
  # ============================================================================
  postgres-test:
    image: postgres:16-alpine
    container_name: {{ app_name }}_postgres_test
    environment:
      POSTGRES_DB: {{ app_name }}_test_db
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    # Use tmpfs for faster tests (in-memory database)
    tmpfs:
      - /var/lib/postgresql/data
    networks:
      - test-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d {{ app_name }}_test_db"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s

  # ============================================================================
  # Test Runner - Execute pytest with coverage
  # ============================================================================
  test:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: {{ app_name }}_test_runner
    environment:
      # Test database connection
      - DATABASE_URL=postgresql+asyncpg://test_user:test_password@postgres-test:5432/{{ app_name }}_test_db
      # Test configuration
      - ENVIRONMENT=test
      - DEBUG=false
      - LOG_LEVEL=WARNING
      - LOG_JSON=false
      # Disable external dependencies in tests
      - REDIS_URL=redis://localhost:6379/0
    depends_on:
      postgres-test:
        condition: service_healthy
    volumes:
      # Mount source code and tests
      - ../src:/app/src:ro
      - ../tests:/app/tests:ro
      # Mount test reports output
      - test-reports:/app/htmlcov
      - test-reports:/app/coverage.xml
    networks:
      - test-network
    command: |
      sh -c "
        echo 'ðŸ”§ Running database migrations...' &&
        alembic upgrade head &&
        echo 'âœ… Migrations complete' &&
        echo '' &&
        echo 'ðŸ§ª Running tests with coverage...' &&
        pytest \
          --verbose \
          --cov=src \
          --cov-report=term-missing \
          --cov-report=html \
          --cov-report=xml \
          --cov-fail-under=80 \
          --tb=short \
          -v &&
        echo '' &&
        echo 'âœ… All tests passed!' &&
        echo 'ðŸ“Š Coverage report saved to htmlcov/index.html'
      "

# ============================================================================
# Named Volumes - Test Reports
# ============================================================================
volumes:
  test-reports:
    driver: local

# ============================================================================
# Networks - Isolated Test Network
# ============================================================================
networks:
  test-network:
    driver: bridge