"""
Security Utilities

Provides security helpers for authentication, authorization, and data sanitization.
"""
import secrets
from typing import Optional
from datetime import datetime, timedelta
import bleach
from slowapi import Limiter
from slowapi.util import get_remote_address
import structlog

logger = structlog.get_logger(__name__)

# Rate limiter instance
limiter = Limiter(
    key_func=get_remote_address,
    default_limits=["100/minute"]
)


def generate_token(length: int = 32) -> str:
    """
    Generate a secure random token.

    Args:
        length: Token length in bytes

    Returns:
        Hex-encoded random token
    """
    return secrets.token_hex(length)


def sanitize_html(content: str, allowed_tags: Optional[list] = None) -> str:
    """
    Sanitize HTML content to prevent XSS attacks.

    Args:
        content: HTML content to sanitize
        allowed_tags: List of allowed HTML tags

    Returns:
        Sanitized HTML content
    """
    if allowed_tags is None:
        allowed_tags = ["b", "i", "u", "em", "strong", "p", "br"]

    return bleach.clean(
        content,
        tags=allowed_tags,
        attributes={},
        strip=True
    )


def sanitize_input(text: str, max_length: int = 1000) -> str:
    """
    Sanitize user input.

    Args:
        text: Input text to sanitize
        max_length: Maximum allowed length

    Returns:
        Sanitized text
    """
    # Strip whitespace
    text = text.strip()

    # Limit length
    if len(text) > max_length:
        text = text[:max_length]

    # Remove any HTML tags
    text = bleach.clean(text, tags=[], strip=True)

    return text


def verify_password_strength(password: str) -> tuple[bool, str]:
    """
    Verify password meets strength requirements.

    Args:
        password: Password to verify

    Returns:
        Tuple of (is_valid, error_message)
    """
    if len(password) < 8:
        return False, "Password must be at least 8 characters long"

    if not any(c.isupper() for c in password):
        return False, "Password must contain at least one uppercase letter"

    if not any(c.islower() for c in password):
        return False, "Password must contain at least one lowercase letter"

    if not any(c.isdigit() for c in password):
        return False, "Password must contain at least one number"

    if not any(c in "!@#$%^&*()-_=+[]{}|;:,.<>?" for c in password):
        return False, "Password must contain at least one special character"

    return True, "Password is strong"


class RateLimitExceeded(Exception):
    """Exception raised when rate limit is exceeded."""
    pass