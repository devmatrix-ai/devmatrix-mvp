"""
Prometheus Metrics Endpoint

Exports application metrics for Prometheus scraping.
"""
from fastapi import APIRouter
from prometheus_client import Counter, Histogram, Gauge, generate_latest, CONTENT_TYPE_LATEST
from starlette.responses import Response

router = APIRouter(prefix="/metrics", tags=["metrics"])

# HTTP Metrics (defined in middleware.py but exported here)
http_requests_total = Counter(
    "http_requests_total",
    "Total HTTP requests",
    ["method", "endpoint", "status"]
)

http_request_duration_seconds = Histogram(
    "http_request_duration_seconds",
    "HTTP request duration in seconds",
    ["method", "endpoint"]
)

{% if entities %}
# Business Metrics
{% for entity in entities %}
{{ entity.snake_name }}_created_total = Counter(
    "{{ entity.snake_name }}_created_total",
    "Total {{ entity.plural_name }} created"
)

{{ entity.snake_name }}_deleted_total = Counter(
    "{{ entity.snake_name }}_deleted_total",
    "Total {{ entity.plural_name }} deleted"
)

{{ entity.snake_name }}_active_count = Gauge(
    "{{ entity.snake_name }}_active_count",
    "Number of active {{ entity.plural_name }}"
)
{% endfor %}
{% endif %}


@router.get("/metrics")
async def metrics():
    """
    Prometheus metrics endpoint.

    Returns:
        Response: Prometheus-formatted metrics
    """
    return Response(
        generate_latest(),
        media_type=CONTENT_TYPE_LATEST
    )
