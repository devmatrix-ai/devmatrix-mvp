# Docker Troubleshooting Guide - {APP_NAME}

Common issues and solutions for Docker infrastructure.

## Service Won't Start

### Symptom
Service container exits immediately or shows "Exited (1)"

### Solutions

1. **Check logs**:
```bash
docker-compose -f docker/docker-compose.yml logs service_name
```

2. **Verify configuration**:
```bash
# Check environment variables
docker-compose -f docker/docker-compose.yml config

# Validate docker-compose.yml syntax
docker-compose -f docker/docker-compose.yml config --quiet
```

3. **Rebuild image**:
```bash
docker-compose -f docker/docker-compose.yml build --no-cache service_name
docker-compose -f docker/docker-compose.yml up -d service_name
```

## Database Connection Failures

### Symptom
App shows "could not connect to server" or "connection refused"

### Solutions

1. **Verify PostgreSQL is running and healthy**:
```bash
docker-compose -f docker/docker-compose.yml ps postgres

# Should show: Up (healthy)
```

2. **Check database is ready**:
```bash
docker-compose -f docker/docker-compose.yml exec postgres pg_isready -U {APP_NAME}_user
```

3. **Verify connection string**:
```bash
# Inside app container
docker-compose -f docker/docker-compose.yml exec app env | grep DATABASE_URL

# Should show: postgresql+asyncpg://{APP_NAME}_user:{APP_NAME}_password@postgres:5432/{APP_NAME}_db
```

4. **Test connection manually**:
```bash
docker-compose -f docker/docker-compose.yml exec postgres \
  psql -U {APP_NAME}_user -d {APP_NAME}_db -c 'SELECT 1;'
```

5. **Check network connectivity**:
```bash
# From app container, ping postgres
docker-compose -f docker/docker-compose.yml exec app ping postgres -c 3
```

## Migration Failures

### Symptom
"alembic.util.exc.CommandError" or "relation does not exist"

### Solutions

1. **Check migration status**:
```bash
docker-compose -f docker/docker-compose.yml exec app alembic current
```

2. **Run migrations manually**:
```bash
docker-compose -f docker/docker-compose.yml exec app alembic upgrade head
```

3. **Reset database (DANGER - deletes all data)**:
```bash
# Stop app
docker-compose -f docker/docker-compose.yml stop app

# Drop and recreate database
docker-compose -f docker/docker-compose.yml exec postgres \
  psql -U {APP_NAME}_user -c 'DROP DATABASE {APP_NAME}_db;'

docker-compose -f docker/docker-compose.yml exec postgres \
  psql -U {APP_NAME}_user -c 'CREATE DATABASE {APP_NAME}_db;'

# Run migrations
docker-compose -f docker/docker-compose.yml exec app alembic upgrade head

# Restart app
docker-compose -f docker/docker-compose.yml restart app
```

4. **Check migration files**:
```bash
docker-compose -f docker/docker-compose.yml exec app ls -la alembic/versions/
```

## Health Check Failures

### Symptom
Service shows "Up (unhealthy)"

### Solutions

1. **Check health check logs**:
```bash
docker inspect $(docker-compose -f docker/docker-compose.yml ps -q app) \
  --format='{{json .State.Health}}' | jq
```

2. **Test health endpoint manually**:
```bash
# For app
curl http://localhost:8000/health/health

# If that fails, check inside container
docker-compose -f docker/docker-compose.yml exec app \
  curl http://localhost:8000/health/health
```

3. **Adjust health check timing**:
Edit `docker-compose.yml` to increase `start_period`:
```yaml
healthcheck:
  start_period: 60s  # Give more time to start
```

4. **Disable health check temporarily** (for debugging):
```yaml
healthcheck:
  disable: true
```

## Port Conflicts

### Symptom
"bind: address already in use"

### Solutions

1. **Check what's using the port**:
```bash
# Linux/Mac
sudo lsof -i :8000

# Find and kill process
sudo kill -9 <PID>
```

2. **Change port mapping**:
Edit `docker-compose.yml`:
```yaml
ports:
  - "8001:8000"  # Use different external port
```

3. **Stop conflicting container**:
```bash
docker ps  # Find container using port
docker stop <container_id>
```

## Volume Permission Errors

### Symptom
"Permission denied" when accessing volumes

### Solutions

1. **Check volume ownership**:
```bash
docker-compose -f docker/docker-compose.yml exec app ls -la /app
```

2. **Fix permissions** (if running as root):
```bash
docker-compose -f docker/docker-compose.yml exec app chown -R appuser:appuser /app
```

3. **Recreate volume**:
```bash
docker-compose -f docker/docker-compose.yml down -v
docker-compose -f docker/docker-compose.yml up -d
```

## Prometheus Not Scraping Metrics

### Symptom
No data in Grafana or Prometheus shows target "down"

### Solutions

1. **Check Prometheus targets**:
Visit http://localhost:9090/targets

2. **Verify metrics endpoint**:
```bash
curl http://localhost:8000/metrics/metrics

# Should return Prometheus metrics format
```

3. **Check Prometheus configuration**:
```bash
docker-compose -f docker/docker-compose.yml exec prometheus cat /etc/prometheus/prometheus.yml
```

4. **Reload Prometheus config**:
```bash
curl -X POST http://localhost:9090/-/reload
```

5. **Check network connectivity**:
```bash
docker-compose -f docker/docker-compose.yml exec prometheus wget -O- http://app:8000/metrics/metrics
```

## Grafana Dashboard Not Loading

### Symptom
Dashboard shows "No data" or doesn't appear

### Solutions

1. **Verify Prometheus datasource**:
- Login to Grafana (http://localhost:3000)
- Go to Configuration > Data Sources
- Click Prometheus
- Click "Test" - should show "Data source is working"

2. **Check dashboard provisioning**:
```bash
docker-compose -f docker/docker-compose.yml exec grafana \
  ls -la /etc/grafana/provisioning/dashboards/
```

3. **Import dashboard manually**:
- Go to Dashboards > Import
- Upload `docker/grafana/dashboards/app-metrics.json`

4. **Check Grafana logs**:
```bash
docker-compose -f docker/docker-compose.yml logs grafana
```

## Out of Memory / Resource Issues

### Symptom
Services crash or containers are killed

### Solutions

1. **Check Docker resource limits**:
```bash
docker info | grep -i memory
docker info | grep -i cpu
```

2. **Increase Docker resources**:
- Docker Desktop: Settings > Resources
- Recommended: 4GB RAM, 2 CPUs minimum

3. **Check container stats**:
```bash
docker stats
```

4. **Add resource limits** to docker-compose.yml:
```yaml
services:
  app:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
```

## Network Issues

### Symptom
Services can't communicate with each other

### Solutions

1. **Verify network exists**:
```bash
docker network ls | grep app-network
```

2. **Inspect network**:
```bash
docker network inspect {APP_NAME}_app-network
```

3. **Recreate network**:
```bash
docker-compose -f docker/docker-compose.yml down
docker-compose -f docker/docker-compose.yml up -d
```

4. **Test connectivity**:
```bash
# From app to postgres
docker-compose -f docker/docker-compose.yml exec app ping postgres -c 3

# From app to redis
docker-compose -f docker/docker-compose.yml exec app ping redis -c 3
```

## Complete Reset

### Nuclear Option
If nothing else works, completely reset:

```bash
# WARNING: This will delete ALL data!

# Stop and remove everything
docker-compose -f docker/docker-compose.yml down -v --rmi all

# Clean up Docker system
docker system prune -a --volumes -f

# Rebuild from scratch
docker-compose -f docker/docker-compose.yml build --no-cache
docker-compose -f docker/docker-compose.yml up -d

# Verify everything is healthy
./docker/validate-docker-setup.sh
```

## Getting Help

If issues persist:

1. **Collect diagnostic information**:
```bash
# Service status
docker-compose -f docker/docker-compose.yml ps

# Logs from all services
docker-compose -f docker/docker-compose.yml logs --tail=100 > docker-logs.txt

# System info
docker info > docker-info.txt
docker version >> docker-info.txt
```

2. **Check GitHub issues**:
Search for similar issues in the project repository

3. **Create detailed issue report** including:
- Error messages
- docker-compose.yml configuration
- Docker version
- Operating system
- Steps to reproduce
