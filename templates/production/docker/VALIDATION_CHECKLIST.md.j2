# Docker Infrastructure Validation Checklist - {APP_NAME}

Use this checklist to validate the complete Docker setup after deployment.

## Pre-Deployment Validation

### Files Present

- [ ] `docker/Dockerfile.j2` exists
- [ ] `docker/docker-compose.yml.j2` exists
- [ ] `docker/docker-compose.test.yml.j2` exists
- [ ] `docker/prometheus.yml.j2` exists
- [ ] `docker/grafana/datasources/prometheus.yml.j2` exists
- [ ] `docker/grafana/dashboards/dashboard-provider.yml.j2` exists
- [ ] `docker/grafana/dashboards/app-metrics.json.j2` exists
- [ ] `docker/.dockerignore.j2` exists
- [ ] `docker/README.md.j2` exists
- [ ] `docker/validate-docker-setup.sh.j2` exists
- [ ] `docker/TROUBLESHOOTING.md.j2` exists

### Configuration Review

- [ ] Dockerfile uses multi-stage build (builder + runtime)
- [ ] Dockerfile creates non-root user (appuser)
- [ ] Dockerfile has health check defined
- [ ] docker-compose.yml defines all 5 services (app, postgres, redis, prometheus, grafana)
- [ ] All services have health checks
- [ ] Services have proper depends_on conditions
- [ ] Volumes are defined for data persistence
- [ ] Network is configured (app-network)
- [ ] Prometheus scrapes app metrics endpoint
- [ ] Grafana has Prometheus datasource configured

## Build Validation

### Docker Image Build

```bash
cd /path/to/{APP_NAME}
docker build -f docker/Dockerfile -t {APP_NAME}:test .
```

- [ ] Build succeeds without errors
- [ ] Build completes in < 5 minutes
- [ ] Image size is reasonable (< 500MB for Python app)
- [ ] No security warnings from Docker

**Check image size**:
```bash
docker images {APP_NAME}:test
```

**Expected**: ~200-400MB for Python 3.11 + FastAPI + dependencies

### Multi-Stage Optimization

```bash
# Check layer sizes
docker history {APP_NAME}:test
```

- [ ] Builder stage uses poetry
- [ ] Runtime stage is slim
- [ ] Only production dependencies included
- [ ] No build tools in final image

## Service Startup Validation

### Start Services

```bash
docker-compose -f docker/docker-compose.yml up -d
```

- [ ] All services start without errors
- [ ] No port conflicts
- [ ] No volume permission errors

### Service Health Checks

Wait 60 seconds for all services to become healthy:

```bash
docker-compose -f docker/docker-compose.yml ps
```

**Expected output**: All services show `Up (healthy)` or `Up`

#### Individual Service Checks

1. **PostgreSQL**:
```bash
docker-compose -f docker/docker-compose.yml exec postgres pg_isready -U {APP_NAME}_user
```
- [ ] Returns "accepting connections"

2. **Redis**:
```bash
docker-compose -f docker/docker-compose.yml exec redis redis-cli ping
```
- [ ] Returns "PONG"

3. **Application**:
```bash
curl http://localhost:8000/health/health
```
- [ ] Returns `{"status": "ok"}`

4. **Prometheus**:
```bash
curl http://localhost:9090/-/healthy
```
- [ ] Returns "Prometheus is Healthy"

5. **Grafana**:
```bash
curl http://localhost:3000/api/health
```
- [ ] Returns `{"database": "ok"}`

## Endpoint Validation

### Application Endpoints

- [ ] **API Documentation**: http://localhost:8000/docs (HTTP 200)
- [ ] **Health Check**: http://localhost:8000/health/health (HTTP 200)
- [ ] **Readiness Check**: http://localhost:8000/health/ready (HTTP 200)
- [ ] **Metrics**: http://localhost:8000/metrics/metrics (HTTP 200)

**Verify metrics format**:
```bash
curl http://localhost:8000/metrics/metrics | grep http_requests_total
```
- [ ] Returns Prometheus format metrics

### Monitoring Endpoints

- [ ] **Prometheus UI**: http://localhost:9090 (loads)
- [ ] **Prometheus Targets**: http://localhost:9090/targets ({APP_NAME} target is UP)
- [ ] **Grafana UI**: http://localhost:3000 (login page)
- [ ] **Grafana Login**: admin/admin works

## Database Validation

### Connection Test

```bash
docker-compose -f docker/docker-compose.yml exec app \
  python -c "from src.core.database import engine; import asyncio; asyncio.run(engine.connect())"
```

- [ ] No connection errors

### Migration Test

```bash
docker-compose -f docker/docker-compose.yml exec app alembic current
```

- [ ] Shows current migration version

```bash
docker-compose -f docker/docker-compose.yml exec app alembic upgrade head
```

- [ ] Migrations run successfully

### Data Persistence Test

1. Create test data:
```bash
curl -X POST http://localhost:8000/api/v1/tasks \
  -H "Content-Type: application/json" \
  -d '{"title": "Test Task", "description": "Docker validation"}'
```

2. Restart app:
```bash
docker-compose -f docker/docker-compose.yml restart app
```

3. Verify data persists:
```bash
curl http://localhost:8000/api/v1/tasks
```

- [ ] Test data still exists after restart

## Metrics & Monitoring Validation

### Prometheus Scraping

1. Generate some traffic:
```bash
for i in {1..10}; do curl http://localhost:8000/health/health; done
```

2. Wait 30 seconds for scrape

3. Check Prometheus:
```bash
curl -s 'http://localhost:9090/api/v1/query?query=http_requests_total' | jq
```

- [ ] Returns metric data with values > 0

### Grafana Dashboard

1. Login to Grafana: http://localhost:3000 (admin/admin)

2. Navigate to Dashboards > {APP_NAME} - Application Metrics

- [ ] Dashboard loads without errors
- [ ] HTTP Request Rate panel shows data
- [ ] Request Duration panel shows data
- [ ] Error Rate gauge is present
- [ ] HTTP Status Codes panel shows data

3. Verify panels update:

- [ ] Data updates every 10 seconds (refresh interval)
- [ ] Time range selector works
- [ ] Hovering over graphs shows tooltips

## Volume Validation

### Check Volumes Exist

```bash
docker volume ls | grep {APP_NAME}
```

- [ ] `{APP_NAME}_postgres-data`
- [ ] `{APP_NAME}_redis-data`
- [ ] `{APP_NAME}_prometheus-data`
- [ ] `{APP_NAME}_grafana-data`

### Volume Persistence Test

1. Stop services:
```bash
docker-compose -f docker/docker-compose.yml down
```

2. Restart services:
```bash
docker-compose -f docker/docker-compose.yml up -d
```

3. Verify data persists:
- [ ] Previous test data still in database
- [ ] Grafana dashboards still configured
- [ ] Prometheus metrics history retained

## Test Environment Validation

### Run Test Suite

```bash
docker-compose -f docker/docker-compose.test.yml up --abort-on-container-exit
```

- [ ] Test database starts
- [ ] Migrations run successfully
- [ ] All tests pass
- [ ] Coverage report generated
- [ ] Coverage â‰¥ 80%

**Check test output**:
- [ ] No test failures
- [ ] No connection errors
- [ ] Clean shutdown

## Performance Validation

### Resource Usage

```bash
docker stats --no-stream
```

**Expected resource usage**:
- [ ] App container: < 200MB RAM
- [ ] PostgreSQL: < 100MB RAM
- [ ] Redis: < 50MB RAM
- [ ] Prometheus: < 200MB RAM
- [ ] Grafana: < 150MB RAM

**Total**: Should be < 700MB RAM

### Startup Time

```bash
time docker-compose -f docker/docker-compose.yml up -d
```

- [ ] Startup completes in < 60 seconds

### Response Time

```bash
curl -w "\nTime: %{time_total}s\n" http://localhost:8000/health/health
```

- [ ] Response time < 100ms

## Network Validation

### Service Communication

1. **App to PostgreSQL**:
```bash
docker-compose -f docker/docker-compose.yml exec app ping postgres -c 3
```
- [ ] Ping successful

2. **App to Redis**:
```bash
docker-compose -f docker/docker-compose.yml exec app ping redis -c 3
```
- [ ] Ping successful

3. **Prometheus to App**:
```bash
docker-compose -f docker/docker-compose.yml exec prometheus wget -O- http://app:8000/metrics/metrics
```
- [ ] Metrics retrieved

### Network Isolation

```bash
docker network inspect {APP_NAME}_app-network
```

- [ ] All 5 containers in network
- [ ] Subnet configured (172.25.0.0/16)
- [ ] Gateway assigned

## Security Validation

### Non-Root User

```bash
docker-compose -f docker/docker-compose.yml exec app whoami
```

- [ ] Returns "appuser" (not root)

### File Permissions

```bash
docker-compose -f docker/docker-compose.yml exec app ls -la /app
```

- [ ] Files owned by appuser:appuser

### Port Exposure

```bash
docker-compose -f docker/docker-compose.yml ps
```

**Verify only intended ports exposed**:
- [ ] App: 8000
- [ ] PostgreSQL: 5432
- [ ] Redis: 6379
- [ ] Prometheus: 9090
- [ ] Grafana: 3000

## Production Readiness

### Environment Variables

- [ ] No hardcoded passwords in docker-compose.yml
- [ ] `.env` file used for sensitive data
- [ ] `.env.example` provided with placeholders

### Secrets Management

- [ ] Database passwords configurable via environment
- [ ] Grafana admin password configurable
- [ ] No secrets in version control

### Logging

```bash
docker-compose -f docker/docker-compose.yml logs app | head -20
```

- [ ] JSON structured logs
- [ ] Log level configurable
- [ ] Request IDs present
- [ ] No sensitive data in logs

## Documentation Validation

- [ ] README.md explains all services
- [ ] README.md has quick start guide
- [ ] README.md lists all endpoints
- [ ] TROUBLESHOOTING.md covers common issues
- [ ] validate-docker-setup.sh exists and is executable

## Final Validation

### Automated Validation Script

```bash
chmod +x docker/validate-docker-setup.sh
./docker/validate-docker-setup.sh
```

- [ ] All validation checks pass
- [ ] No errors reported

### Manual Smoke Test

1. **Create resource**:
```bash
curl -X POST http://localhost:8000/api/v1/tasks \
  -H "Content-Type: application/json" \
  -d '{"title": "Smoke Test", "completed": false}'
```

2. **Read resource**:
```bash
curl http://localhost:8000/api/v1/tasks
```

3. **Check metrics recorded**:
```bash
curl -s http://localhost:8000/metrics/metrics | grep tasks_created_total
```

- [ ] All CRUD operations work
- [ ] Metrics increment correctly

## Sign-Off

### Deployment Checklist Complete

- [ ] All validation steps passed
- [ ] Documentation reviewed
- [ ] Security checks passed
- [ ] Performance acceptable
- [ ] Ready for production deployment

**Validated by**: ________________
**Date**: ________________
**Notes**: ________________

---

## Troubleshooting Failed Validations

If any validation fails:

1. Check logs:
```bash
docker-compose -f docker/docker-compose.yml logs service_name
```

2. Review TROUBLESHOOTING.md for specific issue

3. Run validation script with verbose output:
```bash
bash -x docker/validate-docker-setup.sh
```

4. Collect diagnostic info:
```bash
docker-compose -f docker/docker-compose.yml ps
docker-compose -f docker/docker-compose.yml logs --tail=100 > logs.txt
docker info > docker-info.txt
```

5. Reset and retry:
```bash
docker-compose -f docker/docker-compose.yml down -v
docker-compose -f docker/docker-compose.yml up -d --build
```
