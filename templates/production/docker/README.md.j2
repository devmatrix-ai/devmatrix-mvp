# Docker Infrastructure for {{ app_name }}

Production-ready Docker setup with full observability stack.

## Services

| Service | Port | Description |
|---------|------|-------------|
| **app** | 8000 | FastAPI application |
| **postgres** | 5432 | PostgreSQL 16 database |
| **redis** | 6379 | Redis cache |
| **prometheus** | 9090 | Metrics collection |
| **grafana** | 3000 | Metrics visualization |

## Quick Start

### Development Mode

```bash
# Start all services
docker-compose -f docker/docker-compose.yml up -d

# View logs
docker-compose -f docker/docker-compose.yml logs -f app

# Check service health
docker-compose -f docker/docker-compose.yml ps

# Stop all services
docker-compose -f docker/docker-compose.yml down
```

### Run Tests

```bash
# Run tests in isolated environment
docker-compose -f docker/docker-compose.test.yml up --abort-on-container-exit

# View test coverage report
# Coverage report is saved to: htmlcov/index.html
```

### Rebuild Images

```bash
# Rebuild application image
docker-compose -f docker/docker-compose.yml build app

# Rebuild with no cache
docker-compose -f docker/docker-compose.yml build --no-cache app
```

## Service Endpoints

After running `docker-compose up`:

- **API Documentation**: http://localhost:8000/docs
- **API Health Check**: http://localhost:8000/health/health
- **API Readiness**: http://localhost:8000/health/ready
- **API Metrics**: http://localhost:8000/metrics/metrics
- **Prometheus**: http://localhost:9090
- **Grafana**: http://localhost:3000 (admin/admin)

## Health Checks

All services have health checks configured:

```bash
# Check all services status
docker-compose -f docker/docker-compose.yml ps

# Healthy services show: Up (healthy)
# Unhealthy services show: Up (unhealthy)
```

### Manual Health Checks

```bash
# Application
curl http://localhost:8000/health/health

# PostgreSQL
docker-compose -f docker/docker-compose.yml exec postgres pg_isready

# Redis
docker-compose -f docker/docker-compose.yml exec redis redis-cli ping

# Prometheus
curl http://localhost:9090/-/healthy

# Grafana
curl http://localhost:3000/api/health
```

## Volumes

Persistent data is stored in named volumes:

- `postgres-data`: Database files
- `redis-data`: Cache persistence
- `prometheus-data`: Metrics time-series data
- `grafana-data`: Dashboards and settings

### Backup Volumes

```bash
# Backup PostgreSQL data
docker run --rm -v {{ app_name }}_postgres-data:/data \
  -v $(pwd)/backup:/backup alpine \
  tar czf /backup/postgres-backup.tar.gz -C /data .

# Restore PostgreSQL data
docker run --rm -v {{ app_name }}_postgres-data:/data \
  -v $(pwd)/backup:/backup alpine \
  tar xzf /backup/postgres-backup.tar.gz -C /data
```

### Clean Volumes

```bash
# DANGER: This will delete all data!
docker-compose -f docker/docker-compose.yml down -v
```

## Monitoring

### Prometheus

Access Prometheus at http://localhost:9090

**Useful queries**:

```promql
# Request rate
rate(http_requests_total{service="{{ app_name }}"}[5m])

# Request duration p95
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# Error rate
rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])
```

### Grafana

Access Grafana at http://localhost:3000

**Default credentials**: admin/admin (change on first login)

**Pre-configured dashboards**:
- {{ app_name }} - Application Metrics

## Troubleshooting

### Service won't start

```bash
# View service logs
docker-compose -f docker/docker-compose.yml logs service_name

# Rebuild service
docker-compose -f docker/docker-compose.yml up -d --build service_name
```

### Database connection issues

```bash
# Check PostgreSQL is ready
docker-compose -f docker/docker-compose.yml exec postgres pg_isready

# Verify database exists
docker-compose -f docker/docker-compose.yml exec postgres \
  psql -U {{ app_name }}_user -d {{ app_name }}_db -c '\l'

# Run migrations manually
docker-compose -f docker/docker-compose.yml exec app alembic upgrade head
```

### Performance issues

```bash
# Check resource usage
docker stats

# Check service logs for errors
docker-compose -f docker/docker-compose.yml logs --tail=100
```

### Reset everything

```bash
# Stop services, remove containers and volumes
docker-compose -f docker/docker-compose.yml down -v

# Remove images
docker-compose -f docker/docker-compose.yml down --rmi all

# Start fresh
docker-compose -f docker/docker-compose.yml up -d --build
```

## Production Deployment

### Environment Variables

Create a `.env` file with production values:

```bash
# Application
APP_NAME={{ app_name }}
ENVIRONMENT=production
DEBUG=false
LOG_LEVEL=INFO

# Database (use strong passwords!)
DATABASE_URL=postgresql+asyncpg://user:STRONG_PASSWORD@postgres:5432/{{ app_name }}_db
POSTGRES_PASSWORD=STRONG_PASSWORD

# Security
SECRET_KEY=your-secret-key-here
CORS_ORIGINS=["https://yourdomain.com"]
RATE_LIMIT=100/minute

# Grafana (change default password!)
GF_SECURITY_ADMIN_PASSWORD=STRONG_PASSWORD
```

### Security Checklist

- [ ] Change all default passwords
- [ ] Use strong SECRET_KEY
- [ ] Configure proper CORS_ORIGINS
- [ ] Enable HTTPS in production
- [ ] Review and restrict exposed ports
- [ ] Enable Docker secrets for sensitive data
- [ ] Configure log retention policies
- [ ] Set up automated backups

### Scale Services

```bash
# Scale application instances
docker-compose -f docker/docker-compose.yml up -d --scale app=3
```

## Architecture

```
┌─────────────────────────────────────────────────┐
│                  Docker Network                  │
│                                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │   App    │  │   App    │  │   App    │      │
│  │  :8000   │  │  :8000   │  │  :8000   │      │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘      │
│       │             │             │              │
│       └─────────────┴─────────────┘              │
│                     │                            │
│       ┌─────────────┴─────────────┬──────────┐  │
│       │                           │          │  │
│  ┌────▼─────┐              ┌─────▼────┐ ┌───▼──┐│
│  │PostgreSQL│              │  Redis   │ │ Prom ││
│  │  :5432   │              │  :6379   │ │ :9090││
│  └──────────┘              └──────────┘ └───┬──┘│
│                                             │   │
│                                        ┌────▼──┐│
│                                        │Grafana││
│                                        │ :3000 ││
│                                        └───────┘│
└─────────────────────────────────────────────────┘
```

## Makefile Commands

```bash
# Development
make docker-up          # Start all services
make docker-down        # Stop all services
make docker-logs        # View logs
make docker-ps          # Check service status

# Testing
make docker-test        # Run tests in Docker

# Maintenance
make docker-clean       # Remove containers and volumes
make docker-rebuild     # Rebuild and restart
```
