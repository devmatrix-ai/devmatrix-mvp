#!/bin/bash
# Docker Infrastructure Validation Script for {{ app_name }}
# Generated by DevMatrix - Automated Health Checks

set -e  # Exit on any error

DOCKER_COMPOSE_FILE="docker/docker-compose.yml"
TIMEOUT=60  # seconds to wait for services to be healthy

echo "üê≥ Docker Infrastructure Validation for {{ app_name }}"
echo "=================================================="
echo ""

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to check service health
check_service_health() {
    local service=$1
    local max_attempts=$((TIMEOUT / 5))
    local attempt=1

    echo -n "Checking $service... "

    while [ $attempt -le $max_attempts ]; do
        local status=$(docker-compose -f $DOCKER_COMPOSE_FILE ps $service | grep -i "healthy\|up" || echo "")

        if echo "$status" | grep -q "healthy"; then
            echo -e "${GREEN}‚úÖ HEALTHY${NC}"
            return 0
        elif echo "$status" | grep -q "unhealthy"; then
            echo -e "${RED}‚ùå UNHEALTHY${NC}"
            docker-compose -f $DOCKER_COMPOSE_FILE logs --tail=20 $service
            return 1
        fi

        sleep 5
        attempt=$((attempt + 1))
    done

    echo -e "${RED}‚ùå TIMEOUT${NC}"
    return 1
}

# Function to check HTTP endpoint
check_endpoint() {
    local url=$1
    local expected_status=$2
    local description=$3

    echo -n "Checking $description ($url)... "

    local status=$(curl -s -o /dev/null -w "%{http_code}" $url || echo "000")

    if [ "$status" -eq "$expected_status" ]; then
        echo -e "${GREEN}‚úÖ OK (HTTP $status)${NC}"
        return 0
    else
        echo -e "${RED}‚ùå FAILED (HTTP $status, expected $expected_status)${NC}"
        return 1
    fi
}

# Function to check Prometheus metrics
check_prometheus_metrics() {
    echo -n "Checking Prometheus metrics collection... "

    local metrics=$(curl -s http://localhost:9090/api/v1/targets | grep -o '"health":"up"' | wc -l)

    if [ $metrics -gt 0 ]; then
        echo -e "${GREEN}‚úÖ OK ($metrics targets up)${NC}"
        return 0
    else
        echo -e "${RED}‚ùå FAILED (no targets up)${NC}"
        return 1
    fi
}

# Main validation flow
echo "üìã Step 1: Checking Docker Compose file exists"
if [ ! -f "$DOCKER_COMPOSE_FILE" ]; then
    echo -e "${RED}‚ùå docker-compose.yml not found at $DOCKER_COMPOSE_FILE${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ docker-compose.yml found${NC}"
echo ""

echo "üìã Step 2: Building Docker images"
docker-compose -f $DOCKER_COMPOSE_FILE build --quiet
echo -e "${GREEN}‚úÖ Images built successfully${NC}"
echo ""

echo "üìã Step 3: Starting services"
docker-compose -f $DOCKER_COMPOSE_FILE up -d
echo -e "${GREEN}‚úÖ Services started${NC}"
echo ""

echo "üìã Step 4: Waiting for services to become healthy"
sleep 10  # Give services initial time to start
echo ""

echo "üìã Step 5: Checking service health"
FAILED_SERVICES=0

# Check each service
check_service_health "postgres" || FAILED_SERVICES=$((FAILED_SERVICES + 1))
check_service_health "redis" || FAILED_SERVICES=$((FAILED_SERVICES + 1))
check_service_health "app" || FAILED_SERVICES=$((FAILED_SERVICES + 1))
check_service_health "prometheus" || FAILED_SERVICES=$((FAILED_SERVICES + 1))
check_service_health "grafana" || FAILED_SERVICES=$((FAILED_SERVICES + 1))
echo ""

if [ $FAILED_SERVICES -gt 0 ]; then
    echo -e "${RED}‚ùå $FAILED_SERVICES service(s) failed health checks${NC}"
    echo ""
    echo "Service status:"
    docker-compose -f $DOCKER_COMPOSE_FILE ps
    exit 1
fi

echo "üìã Step 6: Checking HTTP endpoints"
FAILED_ENDPOINTS=0

check_endpoint "http://localhost:8000/health/health" 200 "App health check" || FAILED_ENDPOINTS=$((FAILED_ENDPOINTS + 1))
check_endpoint "http://localhost:8000/health/ready" 200 "App readiness check" || FAILED_ENDPOINTS=$((FAILED_ENDPOINTS + 1))
check_endpoint "http://localhost:8000/metrics/metrics" 200 "App metrics" || FAILED_ENDPOINTS=$((FAILED_ENDPOINTS + 1))
check_endpoint "http://localhost:8000/docs" 200 "API documentation" || FAILED_ENDPOINTS=$((FAILED_ENDPOINTS + 1))
check_endpoint "http://localhost:9090/-/healthy" 200 "Prometheus health" || FAILED_ENDPOINTS=$((FAILED_ENDPOINTS + 1))
check_endpoint "http://localhost:3000/api/health" 200 "Grafana health" || FAILED_ENDPOINTS=$((FAILED_ENDPOINTS + 1))
echo ""

if [ $FAILED_ENDPOINTS -gt 0 ]; then
    echo -e "${RED}‚ùå $FAILED_ENDPOINTS endpoint(s) failed${NC}"
    exit 1
fi

echo "üìã Step 7: Checking Prometheus metrics collection"
sleep 15  # Wait for Prometheus to scrape metrics
check_prometheus_metrics || {
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Prometheus metrics check failed (may need more time)${NC}"
}
echo ""

echo "üìã Step 8: Checking database connectivity"
echo -n "Testing database connection... "
docker-compose -f $DOCKER_COMPOSE_FILE exec -T postgres pg_isready -U {{ app_name }}_user -d {{ app_name }}_db > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Database connection OK${NC}"
else
    echo -e "${RED}‚ùå Database connection failed${NC}"
    exit 1
fi
echo ""

echo "üìã Step 9: Checking Redis connectivity"
echo -n "Testing Redis connection... "
docker-compose -f $DOCKER_COMPOSE_FILE exec -T redis redis-cli ping > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Redis connection OK${NC}"
else
    echo -e "${RED}‚ùå Redis connection failed${NC}"
    exit 1
fi
echo ""

echo "üìã Step 10: Checking volumes"
echo -n "Verifying named volumes exist... "
VOLUMES=$(docker volume ls | grep -E "postgres-data|redis-data|prometheus-data|grafana-data" | wc -l)
if [ $VOLUMES -eq 4 ]; then
    echo -e "${GREEN}‚úÖ All volumes present ($VOLUMES/4)${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Expected 4 volumes, found $VOLUMES${NC}"
fi
echo ""

echo "=================================================="
echo -e "${GREEN}‚úÖ ALL VALIDATIONS PASSED!${NC}"
echo ""
echo "üìä Service Status:"
docker-compose -f $DOCKER_COMPOSE_FILE ps
echo ""
echo "üîó Access URLs:"
echo "   - API Documentation: http://localhost:8000/docs"
echo "   - Health Check: http://localhost:8000/health/health"
echo "   - Metrics: http://localhost:8000/metrics/metrics"
echo "   - Prometheus: http://localhost:9090"
echo "   - Grafana: http://localhost:3000 (admin/admin)"
echo ""
echo "üí° Useful commands:"
echo "   - View logs: docker-compose -f $DOCKER_COMPOSE_FILE logs -f"
echo "   - Stop services: docker-compose -f $DOCKER_COMPOSE_FILE down"
echo "   - Run tests: docker-compose -f docker/docker-compose.test.yml up --abort-on-container-exit"
echo ""
