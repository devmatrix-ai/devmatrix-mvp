name: Precision Tracking

on:
  # Trigger on every commit to track precision changes
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'tests/**'
      - 'scripts/**'

  # Trigger on PRs to validate precision before merge
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'tests/**'

  # Hourly precision measurement
  schedule:
    - cron: '0 * * * *'  # Every hour

  # Manual trigger
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Number of baseline iterations'
        required: false
        default: '10'
        type: string

env:
  POSTGRES_DB: devmatrix_test
  POSTGRES_USER: devmatrix_test
  POSTGRES_PASSWORD: devmatrix_test
  REDIS_HOST: localhost
  REDIS_PORT: 6379
  ENVIRONMENT: test

jobs:
  # Job 1: Determinism Tests
  determinism:
    name: Determinism Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run determinism tests
        run: |
          echo "üé≤ Running determinism tests..."
          pytest tests/test_determinism.py -v -s --tb=short
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: determinism-test-results
          path: |
            reports/
            coverage/
          retention-days: 7

  # Job 2: Baseline Measurement
  baseline:
    name: Precision Baseline Measurement
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: determinism  # Run after determinism tests pass

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run baseline measurement
        run: |
          echo "üìä Running precision baseline measurement..."
          ITERATIONS=${{ github.event.inputs.iterations || '5' }}
          echo "Iterations: $ITERATIONS"

          python scripts/measure_precision_baseline.py \
            --iterations $ITERATIONS \
            --output-dir ./reports/precision
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload baseline reports
        uses: actions/upload-artifact@v4
        with:
          name: precision-baseline-reports
          path: |
            reports/precision/*.json
            reports/precision/*.html
          retention-days: 30

      - name: Save baseline as latest
        run: |
          mkdir -p reports/precision
          # Copy latest report
          LATEST_JSON=$(ls -t reports/precision/baseline_*.json | head -1)
          if [ -f "$LATEST_JSON" ]; then
            cp "$LATEST_JSON" reports/precision/baseline_latest.json
            echo "‚úÖ Latest baseline saved"
          fi

      - name: Parse baseline results
        id: parse_baseline
        run: |
          if [ -f "reports/precision/baseline_latest.json" ]; then
            PRECISION=$(jq -r '.summary.precision_score' reports/precision/baseline_latest.json)
            DETERMINISM=$(jq -r '.summary.determinism_score' reports/precision/baseline_latest.json)
            GAP=$(jq -r '.summary.gap_to_target' reports/precision/baseline_latest.json)

            echo "precision=$PRECISION" >> $GITHUB_OUTPUT
            echo "determinism=$DETERMINISM" >> $GITHUB_OUTPUT
            echo "gap=$GAP" >> $GITHUB_OUTPUT

            echo "üìä Precision: $PRECISION%"
            echo "üé≤ Determinism: $DETERMINISM%"
            echo "üìà Gap to 98% target: $GAP%"
          fi

      - name: Create baseline summary
        run: |
          if [ -f "reports/precision/baseline_latest.json" ]; then
            cat << EOF > $GITHUB_STEP_SUMMARY
          # üéØ Precision Baseline Summary

          ## Metrics
          - **Current Precision**: ${{ steps.parse_baseline.outputs.precision }}%
          - **Determinism Score**: ${{ steps.parse_baseline.outputs.determinism }}%
          - **Gap to Target**: ${{ steps.parse_baseline.outputs.gap }}%
          - **Target**: 98.0%

          ## Progress
          \`\`\`
          [$(printf '=%.0s' {1..$(echo "${{ steps.parse_baseline.outputs.precision }}" | awk '{print int($1/2)}')})]$(printf ' %.0s' {1..$(echo "98 - ${{ steps.parse_baseline.outputs.precision }}" | awk '{print int(($1)/2)}')}) ${{ steps.parse_baseline.outputs.precision }}% / 98%
          \`\`\`

          ## Status
          $([ $(echo "${{ steps.parse_baseline.outputs.gap }}" | awk '{print ($1 < 10)}') -eq 1 ] && echo "üéâ Near target! Less than 10% gap." || echo "‚ö†Ô∏è Need ${{ steps.parse_baseline.outputs.gap }}% improvement to reach 98% target.")

          ---
          *Report generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF
          fi

  # Job 3: Regression Detection
  regression-check:
    name: Precision Regression Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: baseline
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit

      - name: Download baseline report
        uses: actions/download-artifact@v4
        with:
          name: precision-baseline-reports
          path: reports/precision

      - name: Download previous baseline (if exists)
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: precision-tracking.yml
          name: precision-baseline-reports
          path: reports/precision/previous
          branch: ${{ github.base_ref || github.ref_name }}

      - name: Check for regression
        id: regression
        run: |
          CURRENT=$(jq -r '.summary.precision_score' reports/precision/baseline_latest.json)

          if [ -f "reports/precision/previous/baseline_latest.json" ]; then
            PREVIOUS=$(jq -r '.summary.precision_score' reports/precision/previous/baseline_latest.json)
            DIFF=$(echo "$CURRENT - $PREVIOUS" | bc)

            echo "current=$CURRENT" >> $GITHUB_OUTPUT
            echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT
            echo "diff=$DIFF" >> $GITHUB_OUTPUT

            echo "üìä Current: $CURRENT%"
            echo "üìä Previous: $PREVIOUS%"
            echo "üìä Difference: $DIFF%"

            # Fail if regression > 5%
            if (( $(echo "$DIFF < -5" | bc -l) )); then
              echo "‚ùå REGRESSION DETECTED: Precision dropped by ${DIFF#-}%"
              echo "regression=true" >> $GITHUB_OUTPUT
              exit 1
            elif (( $(echo "$DIFF < 0" | bc -l) )); then
              echo "‚ö†Ô∏è Minor regression: Precision dropped by ${DIFF#-}%"
              echo "regression=minor" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ No regression detected"
              echo "regression=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ÑπÔ∏è No previous baseline found - skipping regression check"
            echo "regression=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR (if regression)
        if: github.event_name == 'pull_request' && steps.regression.outputs.regression != 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const current = '${{ steps.regression.outputs.current }}';
            const previous = '${{ steps.regression.outputs.previous }}';
            const diff = '${{ steps.regression.outputs.diff }}';
            const regression = '${{ steps.regression.outputs.regression }}';

            const emoji = regression === 'true' ? '‚ùå' : '‚ö†Ô∏è';
            const severity = regression === 'true' ? 'CRITICAL' : 'MINOR';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${emoji} **${severity} PRECISION REGRESSION DETECTED**\n\n` +
                    `- **Previous**: ${previous}%\n` +
                    `- **Current**: ${current}%\n` +
                    `- **Change**: ${diff}%\n\n` +
                    `Please review the changes that caused this regression.`
            });

  # Job 4: Report Generation
  report:
    name: Generate Precision Report
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [baseline, regression-check]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download baseline reports
        uses: actions/download-artifact@v4
        with:
          name: precision-baseline-reports
          path: reports/precision

      - name: Generate GitHub Pages report
        run: |
          mkdir -p gh-pages

          # Copy HTML report
          cp reports/precision/*.html gh-pages/ || true

          # Create index.html
          cat << 'EOF' > gh-pages/index.html
          <!DOCTYPE html>
          <html>
          <head>
            <title>MGE V2 Precision Tracking</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              h1 { color: #333; }
              .latest { border: 2px solid #4CAF50; padding: 10px; margin: 20px 0; }
            </style>
          </head>
          <body>
            <h1>üéØ MGE V2 Precision Tracking</h1>
            <div class="latest">
              <h2>Latest Baseline Report</h2>
              <p>View the latest precision measurement:</p>
              <ul id="reports"></ul>
            </div>
            <script>
              // List HTML reports
              fetch('.')
                .then(r => r.text())
                .then(html => {
                  const parser = new DOMParser();
                  const doc = parser.parseFromString(html, 'text/html');
                  const links = Array.from(doc.querySelectorAll('a'))
                    .filter(a => a.href.endsWith('.html') && !a.href.includes('index.html'))
                    .sort((a, b) => b.href.localeCompare(a.href));

                  const list = document.getElementById('reports');
                  links.forEach(link => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = link.href.split('/').pop();
                    a.textContent = link.href.split('/').pop();
                    li.appendChild(a);
                    list.appendChild(li);
                  });
                });
            </script>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          publish_branch: gh-pages

  # Job 5: Alert on Failure
  alert:
    name: Alert on Failure
    runs-on: ubuntu-latest
    needs: [determinism, baseline, regression-check]
    if: failure()

    steps:
      - name: Send alert
        run: |
          echo "üö® PRECISION TRACKING FAILURE"
          echo "One or more jobs failed:"
          echo "- Determinism: ${{ needs.determinism.result }}"
          echo "- Baseline: ${{ needs.baseline.result }}"
          echo "- Regression Check: ${{ needs.regression-check.result }}"

      # Optional: Add Slack/Discord/Email notification here
      # - name: Notify Slack
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "üö® Precision tracking failed for ${{ github.repository }}"
      #       }
