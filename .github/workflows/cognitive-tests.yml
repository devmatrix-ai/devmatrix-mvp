name: Cognitive Architecture Tests

on:
  push:
    branches: [main, develop, feature/cognitive-*]
    paths:
      - 'src/cognitive/**'
      - 'tests/cognitive/**'
      - 'scripts/collect_baseline_metrics.py'
      - '.github/workflows/cognitive-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/cognitive/**'
      - 'tests/cognitive/**'
  schedule:
    # Run baseline metrics collection weekly (every Monday at 00:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  NEO4J_VERSION: "5.15"
  QDRANT_VERSION: "v1.7.3"

jobs:
  # ============================================================================
  # Cognitive Architecture Unit Tests
  # ============================================================================
  cognitive-tests:
    name: Cognitive Architecture Tests
    runs-on: ubuntu-latest

    services:
      # Neo4j service for pattern graph tests
      neo4j:
        image: neo4j:${{ env.NEO4J_VERSION }}
        env:
          NEO4J_AUTH: neo4j/devmatrix
          NEO4J_PLUGINS: '["apoc"]'
        ports:
          - 7687:7687
          - 7474:7474
        options: >-
          --health-cmd "cypher-shell -u neo4j -p devmatrix 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # Qdrant service for semantic pattern search tests
      qdrant:
        image: qdrant/qdrant:${{ env.QDRANT_VERSION }}
        ports:
          - 6333:6333
          - 6334:6334
        options: >-
          --health-cmd "curl -f http://localhost:6333/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Wait for Neo4j to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:7474; do sleep 2; done'
          echo "Neo4j is ready"

      - name: Wait for Qdrant to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:6333/health; do sleep 2; done'
          echo "Qdrant is ready"

      - name: Setup test environment
        run: |
          # Create test .env file
          cat > .env.test <<EOF
          NEO4J_URI=bolt://localhost:7687
          NEO4J_USER=neo4j
          NEO4J_PASSWORD=devmatrix
          NEO4J_DATABASE=neo4j
          QDRANT_HOST=localhost
          QDRANT_PORT=6333
          QDRANT_COLLECTION_PATTERNS=devmatrix_patterns
          QDRANT_COLLECTION_SEMANTIC=semantic_patterns
          PATTERN_SIMILARITY_THRESHOLD=0.85
          E2E_PRECISION_TARGET=0.88
          ATOMIC_PRECISION_TARGET=0.92
          EOF

      - name: Run cognitive architecture unit tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest tests/cognitive/ \
            -v \
            --cov=src/cognitive \
            --cov-report=xml \
            --cov-report=term-missing \
            --junitxml=pytest-results.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: cognitive-architecture
          name: cognitive-coverage

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: pytest-results
          path: pytest-results.xml

  # ============================================================================
  # Baseline Metrics Collection (Weekly)
  # ============================================================================
  baseline-metrics:
    name: Collect Baseline Metrics
    runs-on: ubuntu-latest
    # Only run on schedule or manual trigger
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    services:
      neo4j:
        image: neo4j:${{ env.NEO4J_VERSION }}
        env:
          NEO4J_AUTH: neo4j/devmatrix
        ports:
          - 7687:7687
        options: >-
          --health-cmd "cypher-shell -u neo4j -p devmatrix 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      qdrant:
        image: qdrant/qdrant:${{ env.QDRANT_VERSION }}
        ports:
          - 6333:6333
        options: >-
          --health-cmd "curl -f http://localhost:6333/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Wait for services
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:7474; do sleep 2; done'
          timeout 60 bash -c 'until curl -f http://localhost:6333/health; do sleep 2; done'

      - name: Setup environment
        run: |
          cat > .env <<EOF
          NEO4J_URI=bolt://localhost:7687
          NEO4J_USER=neo4j
          NEO4J_PASSWORD=devmatrix
          NEO4J_DATABASE=neo4j
          QDRANT_HOST=localhost
          QDRANT_PORT=6333
          QDRANT_COLLECTION_PATTERNS=devmatrix_patterns
          QDRANT_COLLECTION_SEMANTIC=semantic_patterns
          EOF

      - name: Collect baseline metrics
        run: |
          python scripts/collect_baseline_metrics.py --output metrics/baseline-${{ github.run_number }}.json

      - name: Upload baseline metrics
        uses: actions/upload-artifact@v3
        with:
          name: baseline-metrics
          path: metrics/baseline-*.json

      - name: Display metrics summary
        run: |
          python scripts/collect_baseline_metrics.py

  # ============================================================================
  # Integration Tests (Full Stack)
  # ============================================================================
  integration-tests:
    name: Cognitive Integration Tests
    runs-on: ubuntu-latest
    needs: cognitive-tests

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: devmatrix
          POSTGRES_USER: devmatrix
          POSTGRES_PASSWORD: devmatrix
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      neo4j:
        image: neo4j:${{ env.NEO4J_VERSION }}
        env:
          NEO4J_AUTH: neo4j/devmatrix
        ports:
          - 7687:7687
        options: >-
          --health-cmd "cypher-shell -u neo4j -p devmatrix 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      qdrant:
        image: qdrant/qdrant:${{ env.QDRANT_VERSION }}
        ports:
          - 6333:6333
        options: >-
          --health-cmd "curl -f http://localhost:6333/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Wait for all services
        run: |
          timeout 60 bash -c 'until pg_isready -h localhost -p 5432; do sleep 2; done'
          timeout 60 bash -c 'until curl -f http://localhost:7474; do sleep 2; done'
          timeout 60 bash -c 'until curl -f http://localhost:6333/health; do sleep 2; done'
          timeout 60 bash -c 'until redis-cli -h localhost ping; do sleep 2; done'

      - name: Run database migrations
        env:
          DATABASE_URL: postgresql://devmatrix:devmatrix@localhost:5432/devmatrix
        run: |
          alembic upgrade head

      - name: Run integration tests
        env:
          PYTHONPATH: ${{ github.workspace }}
          DATABASE_URL: postgresql://devmatrix:devmatrix@localhost:5432/devmatrix
          REDIS_HOST: localhost
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: devmatrix
          QDRANT_HOST: localhost
          QDRANT_PORT: 6333
        run: |
          pytest tests/integration/ \
            -v \
            -m "cognitive" \
            --junitxml=integration-results.xml

      - name: Upload integration test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-results
          path: integration-results.xml
